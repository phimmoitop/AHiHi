name: AHiHi to CF (VNRub & Sub)

on:
  workflow_dispatch:
    inputs:
      type: { description: "Type", required: true }
      slug: { description: "Slug", required: true }
      ss: { description: "Season", required: true }
      ep: { description: "Ep", required: true }
      hid: { description: "Hid", required: true }
      token: { description: 'Token', required: true }
      page: { description: 'Page', required: true }
      account: { description: 'AID', required: true }

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Environment
        run: |
          sudo apt update
          sudo apt install -y ffmpeg curl jq python3 python3-pip
          pip3 install edge-tts deep-translator webvtt-py

      # =======================================================
      # BƯỚC 1: LẤY LINK (FIXED THEO JSON MỚI)
      # =======================================================
      - name: Get download and subtitle link
        id: getlink
        run: |
          HID="${{ github.event.inputs.hid }}"
          EP="${{ github.event.inputs.ep }}"

          # 1. Lấy ID của tập phim dựa trên episodeNumber
          HTML=$(curl -s "https://hihianimeapi.onrender.com/api/v1/episodes/a-${HID}")
          LINK_EP=$(echo "$HTML" | jq -r ".data[] | select(.episodeNumber == ($EP|tonumber)) | .id")

          if [ -z "$LINK_EP" ] || [ "$LINK_EP" == "null" ]; then
            echo "❌ Không tìm thấy Episode với số: $EP"
            exit 1
          fi

          # 2. Lấy link Video và Sub
          HTML1=$(curl -s "https://hihianimeapi.onrender.com/api/v1/stream?type=sub&server=hd-2&id=${LINK_EP}")
          LINK_DL=$(echo "$HTML1" | jq -r '.link.file')
          # Ưu tiên sub English, nếu không có lấy sub đầu tiên
          LINK_SUB=$(echo "$HTML1" | jq -r '.tracks[] | select(.label == "English") | .file' | head -n 1)
          if [ -z "$LINK_SUB" ] || [ "$LINK_SUB" == "null" ]; then
            LINK_SUB=$(echo "$HTML1" | jq -r '.tracks[0].file')
          fi

          echo "LINK_DL=$LINK_DL" >> $GITHUB_ENV
          echo "LINK_SUB=$LINK_SUB" >> $GITHUB_ENV
          echo "✅ Đã lấy được link video và sub."

      - name: Download video and subtitle
        run: |
          ffmpeg -i "$LINK_DL" -c copy -bsf:a aac_adtstoasc "raw_video.mp4"
          curl -L "$LINK_SUB" -o "eng.vtt"

      # =======================================================
      # BƯỚC 2: DỊCH SUB + TẠO AUDIO THUYẾT MINH (PYTHON)
      # =======================================================
      - name: Translate Sub and Generate TTS
        run: |
          python3 <<EOF
          import webvtt
          from deep_translator import GoogleTranslator
          import asyncio
          import edge_tts
          import os

          translator = GoogleTranslator(source='en', target='vi')
          
          async def process():
              if not os.path.exists('eng.vtt'): return
              vtt = webvtt.read('eng.vtt')
              vi_vtt = webvtt.WebVTT()
              if not os.path.exists('chunks'): os.makedirs('chunks')
              
              ffmpeg_filter = []
              print(f"Đang xử lý {len(vtt)} câu sub...")

              for i, caption in enumerate(vtt):
                  # Dịch sang tiếng Việt
                  text_vi = translator.translate(caption.text)
                  vi_vtt.captions.append(webvtt.Caption(caption.start, caption.end, text_vi))
                  
                  # Tạo audio (Giọng HoaiMy - Nữ miền Nam rất hợp Anime)
                  chunk_path = f"chunks/chunk_{i}.mp3"
                  communicate = edge_tts.Communicate(text_vi, "vi-VN-HoaiMyNeural")
                  await communicate.save(chunk_path)
                  
                  # Tính toán thời gian bắt đầu (ms)
                  h, m, s = caption.start.split(':')
                  s, ms = s.split('.')
                  start_ms = int(h)*3600000 + int(m)*60000 + int(s)*1000 + int(ms)
                  
                  # Lưu filter để tí nữa FFmpeg dùng
                  ffmpeg_filter.append(f"[{i+1}:a]adelay={start_ms}|{start_ms}[a{i}];")

              vi_vtt.save('vi.vtt')
              with open('audio_filter.txt', 'w') as f:
                  f.write("".join(ffmpeg_filter))
                  mix_ids = "".join([f"[a{j}]" for j in range(len(vtt))])
                  f.write(f"{mix_ids}amix=inputs={len(vtt)}:dropout_transition=0,volume=3.0[tts];")

          asyncio.run(process())
          EOF

      # =======================================================
      # BƯỚC 3: ENCODE HARD-SUB + MIX AUDIO LỒNG TIẾNG
      # =======================================================
      - name: Final Encode and HLS Split
        run: |
          NAME="${{ github.event.inputs.type }}-${{ github.event.inputs.slug }}-${{ github.event.inputs.ss }}-${{ github.event.inputs.ep }}"
          
          # Gom tất cả các file mp3 nhỏ làm input
          INPUTS=""
          COUNT=$(ls chunks/*.mp3 | wc -l)
          for i in $(seq 0 $(($COUNT - 1))); do
            INPUTS="$INPUTS -i chunks/chunk_$i.mp3"
          done

          # Encode: 
          # 1. Add sub Việt cứng vào video
          # 2. Mix audio gốc (giảm vol xuống 0.7) với audio TTS (vol 3.0)
          FILTER_COMPLEX=$(cat audio_filter.txt)
          
          ffmpeg -y -i raw_video.mp4 $INPUTS -filter_complex \
            "${FILTER_COMPLEX}[0:a]volume=0.7[orig_a];[orig_a][tts]amix=inputs=2:duration=first[out_a];[0:v]subtitles=vi.vtt:force_style='FontSize=20,PrimaryColour=&H00FFFF&'[out_v]" \
            -map "[out_v]" -map "[out_a]" -c:v libx264 -preset fast -crf 23 -c:a aac -b:a 128k "final_video.mp4"

          # Convert sang HLS segment PNG
          mkdir -p output
          ffmpeg -y -i "final_video.mp4" -map 0:v:0 -map 0:a? -c:v copy -c:a aac \
            -f hls -start_number 10001 -hls_time 3 -hls_list_size 0 \
            -hls_segment_type fmp4 -hls_fmp4_init_filename "${NAME}-index.png" \
            -hls_segment_filename "output/${NAME}-index%d.png" "output/${NAME}.m3u8"
          
          cp vi.vtt output/

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ github.event.inputs.token }}
          accountId: ${{ github.event.inputs.account }}
          projectName: ${{ github.event.inputs.page }}
          directory: ./output
          branch: ${{ github.event.inputs.type }}-${{ github.event.inputs.slug }}-${{ github.event.inputs.ss }}-${{ github.event.inputs.ep }}
