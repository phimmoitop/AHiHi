name: AHiHi to CF (VNRub & Sub)

on:
  workflow_dispatch:
    inputs:
      type: { description: "Type", required: true }
      slug: { description: "Slug", required: true }
      ss: { description: "Season", required: true }
      ep: { description: "Ep", required: true }
      hid: { description: "Hid", required: true }
      token: { description: 'Token', required: true }
      page: { description: 'Page', required: true }
      account: { description: 'AID', required: true }

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Environment
        run: |
          sudo apt update
          sudo apt install -y ffmpeg curl jq python3 python3-pip
          pip3 install edge-tts deep-translator webvtt-py

      - name: Get download and subtitle link
        id: getlink
        run: |
          HID="${{ github.event.inputs.hid }}"
          EP="${{ github.event.inputs.ep }}"
          HTML=$(curl -s "https://hihianimeapi.onrender.com/api/v1/episodes/a-${HID}")
          LINK_EP=$(echo "$HTML" | grep -oP "\"Episode ${EP}\",\"id\":\"\K[^\"]+")
          HTML1=$(curl -s "https://hihianimeapi.onrender.com/api/v1/stream?type=sub&server=hd-2&id=${LINK_EP}")
          LINK_DL=$(echo "$HTML1" | grep -oP "\"link\":\{\"file\":\"\K[^\"]+")
          LINK_SUB=$(echo "$HTML1" | grep -oP "\"tracks\":\[\{\"file\":\"\K[^\"]+")
          echo "LINK_DL=$LINK_DL" >> $GITHUB_ENV
          echo "LINK_SUB=$LINK_SUB" >> $GITHUB_ENV

      - name: Download video and subtitle
        run: |
          NAME="${{ github.event.inputs.type }}-${{ github.event.inputs.slug }}-${{ github.event.inputs.ss }}-${{ github.event.inputs.ep }}"
          ffmpeg -i "$LINK_DL" -c copy -bsf:a aac_adtstoasc "raw_video.mp4"
          curl -L "$LINK_SUB" -o "eng.vtt"

      # =======================================================
      # BƯỚC 1 & 2: DỊCH SUB VÀ TẠO AUDIO THUYẾT MINH (PYTHON)
      # =======================================================
      - name: Translate Sub and Generate TTS
        run: |
          python3 <<EOF
          import webvtt
          from deep_translator import GoogleTranslator
          import asyncio
          import edge_tts
          import os

          translator = GoogleTranslator(source='en', target='vi')
          
          async def gen_audio():
              vtt = webvtt.read('eng.vtt')
              vi_vtt = webvtt.WebVTT()
              
              # Thư mục chứa các đoạn audio nhỏ
              if not os.path.exists('chunks'): os.makedirs('chunks')
              
              ffmpeg_filter = []
              
              print("Starting translation and TTS...")
              for i, caption in enumerate(vtt):
                  # 1. Dịch văn bản (Phong cách anime thường dùng từ ngữ biểu cảm)
                  translated_text = translator.translate(caption.text)
                  # Một chút tùy chỉnh phong cách anime (ví dụ: gọi tên, hậu tố -kun/san giữ nguyên nếu có)
                  vi_vtt.captions.append(webvtt.Caption(caption.start, caption.end, translated_text))
                  
                  # 2. Tạo Audio cho từng đoạn (Sử dụng giọng HoaiTin hoặc NamMinh)
                  voice = "vi-VN-HoaiMyNeural"
                  communicate = edge_tts.Communicate(translated_text, voice)
                  chunk_name = f"chunks/chunk_{i}.mp3"
                  await communicate.save(chunk_name)
                  
                  # Tính toán thời điểm bắt đầu (giây) để ghép vào FFmpeg
                  start_time_ms = sum(x * int(t) for x, t in zip([3600000, 60000, 1000], caption.start.replace(',', '.').split(':')))
                  # FFmpeg adelay tính bằng ms
                  ffmpeg_filter.append(f"[{i+1}:a]adelay={int(start_time_ms)}|{int(start_time_ms)}[a{i}];")

              vi_vtt.save('vi.vtt')
              
              # Tạo file list cho FFmpeg mix audio
              with open('audio_filter.txt', 'w') as f:
                  f.write("".join(ffmpeg_filter))
                  mix_names = "".join([f"[a{j}]" for j in range(len(vtt))])
                  f.write(f"{mix_names}amix=inputs={len(vtt)}:dropout_transition=0,volume=2.5[tts];")

          asyncio.run(gen_audio())
          EOF

      # =======================================================
      # BƯỚC 3: ENCODE SUB CỨNG + LỒNG AUDIO
      # =======================================================
      - name: Final Encode and HLS Split
        run: |
          NAME="${{ github.event.inputs.type }}-${{ github.event.inputs.slug }}-${{ github.event.inputs.ss }}-${{ github.event.inputs.ep }}"
          
          # Chuẩn bị danh sách input cho FFmpeg (video gốc + hàng trăm file mp3 nhỏ)
          # Lưu ý: Nếu số lượng sub quá lớn (>500), bước này có thể gây lỗi command line quá dài.
          # Tuy nhiên với 1 tập anime ~300 câu sub thì vẫn ổn.
          
          INPUT_FILES=""
          for f in chunks/chunk_*.mp3; do
            INPUT_FILES="$INPUT_FILES -i $f"
          done

          # Chạy FFmpeg: 
          # - Ghép sub tiếng Việt vào video (Hardsub)
          # - Mix audio gốc với audio TTS (Giữ cả hai)
          FILTER_COMPLEX=$(cat audio_filter.txt)
          
          ffmpeg -y -i raw_video.mp4 $INPUT_FILES -filter_complex \
            "${FILTER_COMPLEX}[0:a][tts]amix=inputs=2:duration=first[out_a];[0:v]subtitles=vi.vtt:force_style='FontSize=20,PrimaryColour=&H00FFFF&'[out_v]" \
            -map "[out_v]" -map "[out_a]" -c:v libx264 -preset fast -crf 23 -c:a aac -b:a 128k "final_video.mp4"

          # =======================
          # Convert sang HLS (giữ nguyên logic của bạn)
          # =======================
          mkdir -p output
          ffmpeg -y -i "final_video.mp4" -map 0:v:0 -map 0:a? -c:v copy -c:a aac -b:a 128k \
            -f hls -start_number 10001 -hls_time 3 -hls_list_size 0 \
            -hls_segment_type fmp4 -hls_fmp4_init_filename "${NAME}-index.png" \
            -hls_segment_filename "output/${NAME}-index%d.png" "output/${NAME}.m3u8"
          
          cp vi.vtt output/

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ github.event.inputs.token }}
          accountId: ${{ github.event.inputs.account }}
          projectName: ${{ github.event.inputs.page }}
          directory: ./output
          branch: ${{ github.event.inputs.type }}-${{ github.event.inputs.slug }}-${{ github.event.inputs.ss }}-${{ github.event.inputs.ep }}
