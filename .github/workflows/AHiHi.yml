name: AHiHi to CF (VNRub & Sub)

on:
  workflow_dispatch:
    inputs:
      type: { description: "Type", required: true }
      slug: { description: "Slug", required: true }
      ss: { description: "Season", required: true }
      ep: { description: "Ep", required: true }
      hid: { description: "Hid", required: true }
      token: { description: 'Token', required: true }
      page: { description: 'Page', required: true }
      account: { description: 'AID', required: true }

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Environment
        run: |
          sudo apt update
          sudo apt install -y ffmpeg curl jq python3 python3-pip
          pip3 install edge-tts deep-translator webvtt-py

      # =======================================================
      # BƯỚC 1: LẤY LINK (Đã sửa lỗi jq)
      # =======================================================
      - name: Get download and subtitle link
        id: getlink
        run: |
          HID="${{ github.event.inputs.hid }}"
          EP="${{ github.event.inputs.ep }}"

          # 1. Lấy ID của tập phim
          RESP1=$(curl -s "https://hihianimeapi.onrender.com/api/v1/episodes/a-${HID}")
          LINK_EP=$(echo "$RESP1" | jq -r ".data[] | select(.episodeNumber == ($EP|tonumber)) | .id")

          if [ -z "$LINK_EP" ] || [ "$LINK_EP" == "null" ]; then
            echo "❌ Không tìm thấy Episode ID"
            exit 1
          fi

          # 2. Lấy link Video và Sub (Sửa đường dẫn .data.link.file)
          RESP2=$(curl -s "https://hihianimeapi.onrender.com/api/v1/stream?type=sub&server=hd-2&id=${LINK_EP}")
          LINK_DL=$(echo "$RESP2" | jq -r '.data.link.file')
          LINK_SUB=$(echo "$RESP2" | jq -r '.data.tracks[]? | select(.label == "English") | .file' | head -n 1)

          if [ -z "$LINK_SUB" ] || [ "$LINK_SUB" == "null" ]; then
            LINK_SUB=$(echo "$RESP2" | jq -r '.data.tracks[0].file')
          fi

          if [ -z "$LINK_DL" ] || [ "$LINK_DL" == "null" ]; then
             echo "❌ Không lấy được link download video"
             exit 1
          fi

          echo "LINK_DL=$LINK_DL" >> $GITHUB_ENV
          echo "LINK_SUB=$LINK_SUB" >> $GITHUB_ENV
          echo "✅ Lấy link thành công."

      - name: Download video and subtitle
        run: |
          # Tải video từ m3u8 về mp4
          ffmpeg -i "$LINK_DL" -c copy -bsf:a aac_adtstoasc "raw_video.mp4"
          # Tải subtitle
          curl -L "$LINK_SUB" -o "eng.vtt"

      # =======================================================
      # BƯỚC 2: DỊCH SANG TIẾNG VIỆT + TẠO AUDIO THUYẾT MINH
      # =======================================================
      - name: Translate and Generate TTS
        run: |
          python3 <<EOF
          import webvtt
          from deep_translator import GoogleTranslator
          import asyncio
          import edge_tts
          import os

          async def process():
              if not os.path.exists('eng.vtt'):
                  print("Không có file sub để dịch")
                  return
              
              translator = GoogleTranslator(source='en', target='vi')
              vtt = webvtt.read('eng.vtt')
              vi_vtt = webvtt.WebVTT()
              if not os.path.exists('chunks'): os.makedirs('chunks')
              
              ffmpeg_filter = []
              print(f"Bắt đầu dịch {len(vtt)} câu sub...")

              for i, caption in enumerate(vtt):
                  # Dịch sub (Phong cách Anime Việt)
                  text_vi = translator.translate(caption.text)
                  vi_vtt.captions.append(webvtt.Caption(caption.start, caption.end, text_vi))
                  
                  # Tạo TTS (Giọng HoaiMyNeural - Nữ miền Nam mượt mà)
                  chunk_path = f"chunks/chunk_{i}.mp3"
                  communicate = edge_tts.Communicate(text_vi, "vi-VN-HoaiMyNeural")
                  await communicate.save(chunk_path)
                  
                  # Tính ms để delay audio
                  start_str = caption.start.replace(',', '.')
                  h, m, s = start_str.split(':')
                  start_ms = int(float(h)*3600000 + float(m)*60000 + float(s)*1000)
                  
                  # Ghi vào filter: i+1 vì input 0 là video gốc
                  ffmpeg_filter.append(f"[{i+1}:a]adelay={start_ms}|{start_ms}[a{i}];")

              vi_vtt.save('vi.vtt')
              
              # Tạo file cấu hình filter cho FFmpeg
              with open('audio_filter.txt', 'w') as f:
                  f.write("".join(ffmpeg_filter))
                  mix_ids = "".join([f"[a{j}]" for j in range(len(vtt))])
                  # Mix các câu TTS lại thành 1 track, tăng âm lượng lên 3 lần
                  f.write(f"{mix_ids}amix=inputs={len(vtt)}:dropout_transition=0,volume=3.0[tts];")

          asyncio.run(process())
          EOF

      # =======================================================
      # BƯỚC 3: GHÉP AUDIO + HARD-SUB + RENDER HLS
      # =======================================================
      - name: Final Render and HLS
        run: |
          NAME="${{ github.event.inputs.type }}-${{ github.event.inputs.slug }}-${{ github.event.inputs.ss }}-${{ github.event.inputs.ep }}"
          
          # Chuẩn bị danh sách input (Video gốc + các chunk MP3)
          INPUTS="-i raw_video.mp4"
          COUNT=$(ls chunks/chunk_*.mp3 | wc -l)
          for i in $(seq 0 $(($COUNT - 1))); do
            INPUTS="$INPUTS -i chunks/chunk_$i.mp3"
          done

          FILTER_COMPLEX=$(cat audio_filter.txt)
          
          # Thực hiện: 
          # 1. Mix Audio gốc (vol 0.8) và Audio TTS (vol 3.0)
          # 2. Chèn sub tiếng Việt vào video (Hardsub)
          ffmpeg -y $INPUTS -filter_complex \
            "${FILTER_COMPLEX}[0:a]volume=0.8[orig_a];[orig_a][tts]amix=inputs=2:duration=first[out_a];[0:v]subtitles=vi.vtt:force_style='FontSize=20,PrimaryColour=&H00FFFF&'[out_v]" \
            -map "[out_v]" -map "[out_a]" -c:v libx264 -preset superfast -crf 23 -c:a aac -b:a 128k "final_output.mp4"

          # Convert sang HLS segment PNG như yêu cầu của bạn
          mkdir -p output
          ffmpeg -y -i "final_output.mp4" -map 0:v:0 -map 0:a? -c:v copy -c:a aac \
            -f hls -start_number 10001 -hls_time 3 -hls_list_size 0 \
            -hls_segment_type fmp4 -hls_fmp4_init_filename "${NAME}-index.png" \
            -hls_segment_filename "output/${NAME}-index%d.png" "output/${NAME}.m3u8"
          
          cp vi.vtt output/

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ github.event.inputs.token }}
          accountId: ${{ github.event.inputs.account }}
          projectName: ${{ github.event.inputs.page }}
          directory: ./output
          branch: ${{ github.event.inputs.type }}-${{ github.event.inputs.slug }}-${{ github.event.inputs.ss }}-${{ github.event.inputs.ep }}
