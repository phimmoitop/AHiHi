name: AHiHi to CF (VNRub & Sub)

on:
  workflow_dispatch:
    inputs:
      type: { description: "Type", required: true }
      slug: { description: "Slug", required: true }
      ss: { description: "Season", required: true }
      ep: { description: "Ep", required: true }
      hid: { description: "Hid", required: true }
      token: { description: 'Token', required: true }
      page: { description: 'Page', required: true }
      account: { description: 'AID', required: true }

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Environment
        run: |
          sudo apt update
          sudo apt install -y ffmpeg curl jq python3 python3-pip
          pip3 install edge-tts deep-translator webvtt-py

      # =======================================================
      # B∆Ø·ªöC 1: L·∫§Y LINK T·ª™ API (ƒê√£ s·ª≠a l·ªói c·∫•u h√¨nh JSON)
      # =======================================================
      - name: Get download and subtitle link
        id: getlink
        run: |
          HID="${{ github.event.inputs.hid }}"
          EP="${{ github.event.inputs.ep }}"

          RESP1=$(curl -s "https://hihianimeapi.onrender.com/api/v1/episodes/a-${HID}")
          LINK_EP=$(echo "$RESP1" | jq -r ".data[] | select(.episodeNumber == ($EP|tonumber)) | .id")

          if [ -z "$LINK_EP" ] || [ "$LINK_EP" == "null" ]; then
            echo "‚ùå Kh√¥ng t√¨m th·∫•y Episode ID cho t·∫≠p $EP"
            exit 1
          fi

          RESP2=$(curl -s "https://hihianimeapi.onrender.com/api/v1/stream?type=sub&server=hd-2&id=${LINK_EP}")
          LINK_DL=$(echo "$RESP2" | jq -r '.data.link.file')
          LINK_SUB=$(echo "$RESP2" | jq -r '.data.tracks[]? | select(.label == "English") | .file' | head -n 1)

          if [ -z "$LINK_SUB" ] || [ "$LINK_SUB" == "null" ]; then
            LINK_SUB=$(echo "$RESP2" | jq -r '.data.tracks[0].file')
          fi

          echo "LINK_DL=$LINK_DL" >> $GITHUB_ENV
          echo "LINK_SUB=$LINK_SUB" >> $GITHUB_ENV
          echo "‚úÖ ƒê√£ l·∫•y link video: $LINK_DL"

      - name: Download video and subtitle
        run: |
          ffmpeg -i "$LINK_DL" -c copy -bsf:a aac_adtstoasc "raw_video.mp4"
          curl -L "$LINK_SUB" -o "eng.vtt"

      # =======================================================
      # B∆Ø·ªöC 2: D·ªäCH PHONG C√ÅCH ANIME + TTS (G·ª¨I TI·∫æN ƒê·ªò)
      # =======================================================
      - name: Translate and Generate TTS
        run: |
          python3 <<EOF
          import webvtt
          from deep_translator import GoogleTranslator
          import asyncio
          import edge_tts
          import os
          import re

          def anime_style_refine(text, original_text):
              # 1. Gi·ªØ nguy√™n t√™n ri√™ng (c√°c t·ª´ vi·∫øt hoa trong b·∫£n g·ªëc)
              # T√¨m c√°c t·ª´ vi·∫øt hoa trong b·∫£n g·ªëc (kh√¥ng t√≠nh ƒë·∫ßu d√≤ng)
              proper_nouns = re.findall(r'\b[A-Z][a-z]+\b', original_text)
              
              # 2. Thay ƒë·ªïi ƒë·∫°i t·ª´ nh√¢n x∆∞ng cho gi·ªëng Anime
              pronouns = {
                  r"\bb·∫°n\b": "c·∫≠u",
                  r"\bt√¥i\b": "t·ªõ",
                  r"\banh ·∫•y\b": "anh ta",
                  r"\bc√¥ ·∫•y\b": "c√¥ ta",
                  r"\bh·ªç\b": "ch√∫ng",
                  r"\bv√¢ng\b": "ƒë∆∞·ª£c th√¥i",
                  r"\bv√¢ng ·∫°\b": "ƒë√£ r√µ",
                  r"\b√¥ng\b": "ng√†i",
                  r"\bb√†\b": "b√† ·∫•y"
              }
              
              refined = text.lower()
              for key, val in pronouns.items():
                  refined = re.sub(key, val, refined)
              
              # 3. Vi·∫øt hoa nh·ªØng t·ª´ quan tr·ªçng/t√™n ng∆∞·ªùi ƒë√£ t√¨m th·∫•y ·ªü b∆∞·ªõc 1
              for name in proper_nouns:
                  # T√¨m t√™n trong b·∫£n d·ªãch (kh√¥ng ph√¢n bi·ªát hoa th∆∞·ªùng) v√† thay b·∫±ng t√™n g·ªëc
                  pattern = re.compile(re.escape(name), re.IGNORECASE)
                  refined = pattern.sub(name, refined)
                  
              return refined.strip().capitalize()

          async def process():
              if not os.path.exists('eng.vtt'): return
              
              translator = GoogleTranslator(source='en', target='vi')
              vtt = webvtt.read('eng.vtt')
              vi_vtt = webvtt.WebVTT()
              if not os.path.exists('chunks'): os.makedirs('chunks')
              
              ffmpeg_filter = []
              total = len(vtt)
              
              print(f"üöÄ B·∫Øt ƒë·∫ßu x·ª≠ l√Ω {total} c√¢u tho·∫°i...")

              for i, caption in enumerate(vtt):
                  # D·ªãch m√°y
                  raw_vi = translator.translate(caption.text)
                  # Tinh ch·ªânh phong c√°ch
                  text_vi = anime_style_refine(raw_vi, caption.text)
                  
                  # HI·ªÇN TH·ªä TI·∫æN ƒê·ªò
                  percent = round(((i + 1) / total) * 100, 1)
                  print(f"[{percent}%] [{caption.start}] -> {text_vi}")
                  
                  vi_vtt.captions.append(webvtt.Caption(caption.start, caption.end, text_vi))
                  
                  # T·∫†O AUDIO (S·ª≠ d·ª•ng gi·ªçng HoaiMy m∆∞·ª£t m√†)
                  chunk_path = f"chunks/chunk_{i}.mp3"
                  communicate = edge_tts.Communicate(text_vi, "vi-VN-HoaiMyNeural")
                  await communicate.save(chunk_path)
                  
                  # T√≠nh th·ªùi gian ƒë·ªÉ kh·ªõp audio
                  h, m, s = caption.start.replace(',', '.').split(':')
                  start_ms = int(float(h)*3600000 + float(m)*60000 + float(s)*1000)
                  ffmpeg_filter.append(f"[{i+1}:a]adelay={start_ms}|{start_ms}[a{i}];")

              vi_vtt.save('vi.vtt')
              with open('audio_filter.txt', 'w') as f:
                  f.write("".join(ffmpeg_filter))
                  mix_ids = "".join([f"[a{j}]" for j in range(len(vtt))])
                  f.write(f"{mix_ids}amix=inputs={len(vtt)}:dropout_transition=0,volume=3.5[tts];")

          asyncio.run(process())
          EOF

      # =======================================================
      # B∆Ø·ªöC 3: GH√âP AUDIO + HARD-SUB + RENDER HLS
      # =======================================================
      - name: Final Render and HLS
        run: |
          NAME="${{ github.event.inputs.type }}-${{ github.event.inputs.slug }}-${{ github.event.inputs.ss }}-${{ github.event.inputs.ep }}"
          
          # Gom file MP3 l√†m input
          INPUTS="-i raw_video.mp4"
          COUNT=$(ls chunks/chunk_*.mp3 | wc -l)
          for i in $(seq 0 $(($COUNT - 1))); do
            INPUTS="$INPUTS -i chunks/chunk_$i.mp3"
          done

          FILTER_COMPLEX=$(cat audio_filter.txt)
          
          # Mix Audio (Gi·∫£m nh·∫°c g·ªëc xu·ªëng 0.6, tƒÉng TTS l√™n cao) + Hardsub ti·∫øng Vi·ªát
          ffmpeg -y $INPUTS -filter_complex \
            "${FILTER_COMPLEX}[0:a]volume=0.6[orig_a];[orig_a][tts]amix=inputs=2:duration=first[out_a];[0:v]subtitles=vi.vtt:force_style='FontSize=18,PrimaryColour=&H00FFFF&,OutlineColour=&H000000&,BorderStyle=1,Outline=2'[out_v]" \
            -map "[out_v]" -map "[out_a]" -c:v libx264 -preset fast -crf 23 -c:a aac -b:a 128k "final_output.mp4"

          # T√°ch HLS (.png)
          mkdir -p output
          ffmpeg -y -i "final_output.mp4" -map 0:v:0 -map 0:a? -c:v copy -c:a aac \
            -f hls -start_number 10001 -hls_time 3 -hls_list_size 0 \
            -hls_segment_type fmp4 -hls_fmp4_init_filename "${NAME}-index.png" \
            -hls_segment_filename "output/${NAME}-index%d.png" "output/${NAME}.m3u8"
          
          cp vi.vtt output/

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ github.event.inputs.token }}
          accountId: ${{ github.event.inputs.account }}
          projectName: ${{ github.event.inputs.page }}
          directory: ./output
          branch: ${{ github.event.inputs.type }}-${{ github.event.inputs.slug }}-${{ github.event.inputs.ss }}-${{ github.event.inputs.ep }}
